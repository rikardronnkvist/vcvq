<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vibe Coded Vibe Quiz – Game</title>
  <link rel="icon" href="/favicon.svg" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div>
        <h1>Vibe Coded Vibe Quiz</h1>
        <div id="roomInfo" style="color:var(--muted);"></div>
      </div>
      <div class="controls">
        <button id="startBtn" data-i18n="start">Start</button>
        <button id="restartBtn" class="secondary" data-i18n="restart">Restart</button>
      </div>
    </div>
    <div class="card">
      <div class="scoreboard" id="scoreboard"></div>
      <div class="board">
        <div class="question" id="question">—</div>
        <div class="answers" id="answers"></div>
      </div>
    </div>
  </div>
  <div id="token" class="token" draggable="true" title="Drag to answer">#</div>
  <script src="/i18n.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" integrity="sha384-Q2ONgQnYLzJQ7j4bQ+1ng0q6hSz4EtnpM6ZPGv3YHGB1Jr2qBNgEH5qjV1Xv7ViY" crossorigin="anonymous"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const roomId = params.get('room');
    const claimedPlayer = Number(params.get('player')) || null;
    const socket = io();
    const $ = sel => document.querySelector(sel);
    const t = (k)=> translate(localStorage.getItem('vcvq_lang')||'sv', k);

    const scoreboard = $('#scoreboard');
    const questionEl = $('#question');
    const answersEl = $('#answers');
    const startBtn = $('#startBtn');
    const restartBtn = $('#restartBtn');
    const token = $('#token');
    const roomInfo = $('#roomInfo');

    let state = null;
    let myPlayerNumber = claimedPlayer; // optional

    if (!roomId) {
      alert('Missing room code');
      location.href = '/';
    }

    socket.emit('join_room', { roomId, playerNumber: myPlayerNumber }, (res)=>{
      if(!res?.ok){ alert(res?.error || 'Join failed'); location.href='/'; return; }
      state = res.state;
      renderAll();
    });

    socket.on('state', (st)=>{ state = st; renderAll(); });
    socket.on('game_started', (st)=>{ state = st; renderAll(); });
    socket.on('question', payload=>{ renderQuestion(payload); });
    socket.on('answer_result', payload=>{ showAnswerResult(payload); });
    socket.on('game_over', payload=>{ showGameOver(payload); });

    startBtn.addEventListener('click', ()=>{
      socket.emit('start_game', { roomId }, ()=>{});
    });
    restartBtn.addEventListener('click', ()=>{
      socket.emit('restart', { roomId }, ()=>{});
    });

    function renderAll(){
      if (!state) return;
      document.documentElement.lang = state.lang || 'sv';
      roomInfo.textContent = `${t('room')} ${roomId} • ${t('topic')}: ${state.topic}`;
      renderScores();
      if (state.started) startBtn.disabled = true; else startBtn.disabled = false;
      tokenSetup();
    }

    function renderScores(){
      scoreboard.innerHTML = '';
      state.players.forEach((p,idx)=>{
        const el = document.createElement('div');
        el.className = 'player' + (idx===state.turnIndex?' turn':'');
        el.innerHTML = `<div class="badge" style="background:${p.color}">${p.number}</div><div><div style="font-weight:700">${p.name}</div><div style="color:var(--muted)">${t('score')}: ${p.score}</div></div>`;
        scoreboard.appendChild(el);
      });
    }

    function renderQuestion(q){
      answersEl.innerHTML = '';
      questionEl.textContent = q.question || '—';
      q.options.forEach((opt, i)=>{
        const box = document.createElement('div');
        box.className = 'answer';
        box.dataset.index = i;
        box.innerHTML = `<div class="label">${String.fromCharCode(65+i)}</div><div class="choice">${opt}</div>`;
        // DnD targets
        box.addEventListener('dragover', ev=>{ ev.preventDefault(); });
        box.addEventListener('drop', ev=>{
          ev.preventDefault();
          onDropAnswer(i);
        });
        answersEl.appendChild(box);
      });
      tokenSetup();
    }

    function onDropAnswer(i){
      if (!state) return;
      const current = state.turnIndex + 1;
      if (myPlayerNumber && current !== myPlayerNumber) return; // not my turn
      socket.emit('answer', { roomId, optionIndex: i, playerNumber: current }, ()=>{});
    }

    function showAnswerResult({ playerNumber, optionIndex, correct, correctIndex, scores }){
      // update scores locally
      if (scores) {
        state.players.forEach((p, idx)=> p.score = scores[idx]);
        renderScores();
      }
      // visuals
      const boxes = [...document.querySelectorAll('.answer')];
      boxes.forEach(b=>b.classList.remove('correct','incorrect'));
      const chosen = boxes[optionIndex];
      const correctBox = boxes[correctIndex];
      if (chosen) chosen.classList.add(correct ? 'correct' : 'incorrect');
      if (!correct && correctBox) correctBox.classList.add('correct');
      token.classList.add('disabled');
    }

    function showGameOver({ winners, scores }){
      const names = winners.map(w=>`${w.name} (${t('score')}: ${w.score})`).join(', ');
      alert(`${t('winners')}: ${names}`);
      startBtn.disabled = false;
      token.classList.add('disabled');
    }

    function tokenSetup(){
      const current = state?.turnIndex + 1;
      const myTurn = !myPlayerNumber || myPlayerNumber === current;
      const color = state?.players?.[state.turnIndex]?.color || '#999';
      token.textContent = current || '#';
      token.style.background = color;
      token.classList.toggle('disabled', !state?.started || !myTurn);
      // Make token draggable and use HTML5 DnD ghost
      token.addEventListener('dragstart', ev=>{
        ev.dataTransfer.setData('text/plain', 'token');
        ev.dataTransfer.effectAllowed = 'move';
      });
      token.addEventListener('dragend', ev=>{});
    }
  </script>
</body>
</html>