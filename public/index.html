<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vibe Coded Vibe Quiz</title>
  <link rel="icon" type="image/x-icon" href="logo.ico">
  <link rel="stylesheet" href="styles.css">
  <script src="i18n.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <img src="logo.png" alt="VCVQ Logo" class="logo">
    </header>

    <div class="setup-form">
      <div class="form-group">
        <label for="language" id="labelLanguage">Language:</label>
        <select id="language">
          <option value="sv">Svenska</option>
          <option value="en">English</option>
        </select>
      </div>

      <div class="form-group">
        <label for="topic" id="labelTopic">Quiz Topic:</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="topicInput" placeholder="Enter any topic (e.g., Science, Movies, Sports)" style="flex: 1;">
          <select id="topicDropdown" style="flex: 1; display: none;"></select>
          <button id="randomTopicBtn" class="btn-generate" style="padding: 12px 20px; white-space: nowrap;">üé≤ Random</button>
          <button id="customTopicBtn" class="btn-generate" style="padding: 12px 20px; white-space: nowrap; display: none;">‚úèÔ∏è Custom</button>
        </div>
      </div>

      <div class="form-group form-group-inline">
        <div class="inline-field">
          <label for="playerCount" id="labelPlayerCount">Number of Players:</label>
          <select id="playerCount">
            <option value="2" selected>2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <div class="inline-field">
          <label for="questionCount" id="labelQuestionCount">Number of Questions:</label>
          <select id="questionCount">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="15">15</option>
            <option value="20">20</option>
            <option value="25">25</option>
            <option value="30">30</option>
            <option value="50">50</option>
          </select>
        </div>
        <div class="inline-field">
          <label for="answerCount" id="labelAnswerCount">Number of Answers:</label>
          <select id="answerCount">
            <option value="4">4</option>
            <option value="6" selected>6</option>
            <option value="8">8</option>
          </select>
        </div>
      </div>

      <div id="playerNames">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 id="labelPlayerNames">Player Names:</h3>
          <button id="generateNamesBtn" class="btn-generate"></button>
        </div>
        <div class="player-name-input">
          <label id="labelPlayer1">Player 1:</label>
          <input type="text" id="player1" value="">
        </div>
        <div class="player-name-input">
          <label id="labelPlayer2">Player 2:</label>
          <input type="text" id="player2" value="">
        </div>
        <div class="player-name-input">
          <label id="labelPlayer3">Player 3:</label>
          <input type="text" id="player3" value="">
        </div>
        <div class="player-name-input">
          <label id="labelPlayer4">Player 4:</label>
          <input type="text" id="player4" value="">
        </div>
        <div class="player-name-input">
          <label id="labelPlayer5">Player 5:</label>
          <input type="text" id="player5" value="">
        </div>
      </div>

      <button id="startBtn" class="btn-primary">Start Quiz</button>
      <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p id="loadingText">Generating quiz questions...</p>
      </div>
      <div id="error" class="error" style="display: none;"></div>
    </div>
  </div>

  <script>
    const playerCountSelect = document.getElementById('playerCount');
    const playerNameInputs = document.querySelectorAll('.player-name-input');
    const startBtn = document.getElementById('startBtn');
    const generateNamesBtn = document.getElementById('generateNamesBtn');
    const loading = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const languageSelect = document.getElementById('language');

    let currentLang = 'en';

    const defaultNames = {
      sv: ['F√∂rare', 'Fram passagerare', 'V√§nster bak', 'H√∂ger bak', 'Mitten bak'],
      en: ['Driver', 'Front Passenger', 'Left Back Passenger', 'Right Back Passenger', 'Middle Back Passenger']
    };

    function updatePlayerInputs() {
      const count = parseInt(playerCountSelect.value);
      console.log(`[VCVQ] Updating player inputs for ${count} players`);
      playerNameInputs.forEach((input, idx) => {
        input.style.display = idx < count ? 'flex' : 'none';
      });
    }

    function updateLanguage() {
      const lang = languageSelect.value;
      currentLang = lang;
      console.log(`[VCVQ] Language changed to: ${lang}`);
      
      // Update labels
      document.getElementById('labelLanguage').textContent = t('languageSelector', lang) + ':';
      document.getElementById('labelTopic').textContent = t('topic', lang) + ':';
      document.getElementById('topicInput').placeholder = t('topicPlaceholder', lang);
      document.getElementById('randomTopicBtn').textContent = t('randomTopic', lang);
      document.getElementById('customTopicBtn').textContent = t('customTopic', lang);
      document.getElementById('labelPlayerCount').textContent = t('numberOfPlayers', lang) + ':';
      document.getElementById('labelQuestionCount').textContent = t('numberOfQuestions', lang) + ':';
      document.getElementById('labelAnswerCount').textContent = t('numberOfAnswers', lang) + ':';
      document.getElementById('labelPlayerNames').textContent = t('playerNames', lang) + ':';
      document.getElementById('generateNamesBtn').textContent = t('generateNames', lang);
      startBtn.textContent = t('startQuiz', lang);
      document.getElementById('loadingText').textContent = t('generatingQuiz', lang);
      
      // Update player labels and default names
      for (let i = 1; i <= 5; i++) {
        document.getElementById(`labelPlayer${i}`).textContent = `${t('player', lang)} ${i}:`;
        const input = document.getElementById(`player${i}`);
        // Update if it's still a default name from the other language or empty
        if (input.value === '' || defaultNames.sv.includes(input.value) || defaultNames.en.includes(input.value)) {
          input.value = defaultNames[lang][i - 1];
        }
      }
    }

    async function generateRandomTopics() {
      const lang = languageSelect.value;
      const randomTopicBtn = document.getElementById('randomTopicBtn');
      
      console.log(`[VCVQ] Generating 10 random topics in ${lang}`);
      randomTopicBtn.disabled = true;
      
      // Show loading overlay
      loading.style.display = 'flex';
      document.getElementById('loadingText').textContent = t('generatingTopics', lang);
      
      try {
        const response = await fetch('/api/generate-topic', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ language: lang, count: 10 })
        });

        if (!response.ok) {
          throw new Error('Failed to generate topics');
        }

        const data = await response.json();
        console.log(`[VCVQ] Generated topics:`, data.topics);
        
        // Hide loading overlay
        loading.style.display = 'none';
        
        // Switch to dropdown
        const topicInput = document.getElementById('topicInput');
        const topicDropdown = document.getElementById('topicDropdown');
        const customTopicBtn = document.getElementById('customTopicBtn');
        
        topicInput.style.display = 'none';
        topicDropdown.style.display = 'block';
        randomTopicBtn.style.display = 'none';
        customTopicBtn.style.display = 'block';
        
        // Populate dropdown
        topicDropdown.innerHTML = data.topics.map(topic => 
          `<option value="${topic}">${topic}</option>`
        ).join('');
        
        randomTopicBtn.disabled = false;
      } catch (error) {
        console.error('[VCVQ] Error generating topics:', error);
        loading.style.display = 'none';
        randomTopicBtn.textContent = '‚úó';
        setTimeout(() => {
          randomTopicBtn.textContent = t('randomTopic', lang);
          randomTopicBtn.disabled = false;
        }, 1500);
      }
    }

    function switchToCustomTopic() {
      const topicInput = document.getElementById('topicInput');
      const topicDropdown = document.getElementById('topicDropdown');
      const randomTopicBtn = document.getElementById('randomTopicBtn');
      const customTopicBtn = document.getElementById('customTopicBtn');
      
      topicDropdown.style.display = 'none';
      topicInput.style.display = 'block';
      customTopicBtn.style.display = 'none';
      randomTopicBtn.style.display = 'block';
      
      topicInput.value = '';
      topicInput.focus();
    }

    function getCurrentTopic() {
      const topicInput = document.getElementById('topicInput');
      const topicDropdown = document.getElementById('topicDropdown');
      
      if (topicDropdown.style.display === 'none') {
        return topicInput.value.trim();
      } else {
        return topicDropdown.value;
      }
    }

    async function generatePlayerNames() {
      const count = parseInt(playerCountSelect.value);
      const lang = languageSelect.value;
      const topic = getCurrentTopic();
      
      console.log(`[VCVQ] Generating ${count} AI player names in ${lang} for topic: ${topic}`);
      generateNamesBtn.disabled = true;
      
      // Show loading overlay
      loading.style.display = 'flex';
      document.getElementById('loadingText').textContent = t('generatingPlayerNames', lang);
      
      try {
        const response = await fetch('/api/generate-player-names', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ language: lang, count, topic })
        });

        if (!response.ok) {
          throw new Error('Failed to generate names');
        }

        const data = await response.json();
        console.log(`[VCVQ] Received generated names:`, data.names);
        
        // Hide loading overlay
        loading.style.display = 'none';
        
        for (let i = 0; i < count; i++) {
          document.getElementById(`player${i + 1}`).value = data.names[i];
        }
        
        generateNamesBtn.textContent = '‚úì';
        setTimeout(() => {
          generateNamesBtn.textContent = t('generateNames', lang);
          generateNamesBtn.disabled = false;
        }, 1500);
      } catch (error) {
        console.error('[VCVQ] Error generating names:', error);
        loading.style.display = 'none';
        generateNamesBtn.textContent = '‚úó';
        setTimeout(() => {
          generateNamesBtn.textContent = t('generateNames', lang);
          generateNamesBtn.disabled = false;
        }, 1500);
      }
    }

    playerCountSelect.addEventListener('change', updatePlayerInputs);
    languageSelect.addEventListener('change', updateLanguage);
    document.getElementById('randomTopicBtn').addEventListener('click', generateRandomTopics);
    document.getElementById('customTopicBtn').addEventListener('click', switchToCustomTopic);
    generateNamesBtn.addEventListener('click', generatePlayerNames);
    updatePlayerInputs();

    startBtn.addEventListener('click', async () => {
      const topic = getCurrentTopic();
      const playerCount = parseInt(playerCountSelect.value);
      const questionCount = parseInt(document.getElementById('questionCount').value);
      const answerCount = parseInt(document.getElementById('answerCount').value);
      const language = languageSelect.value;
      
      console.log(`[VCVQ] Starting quiz - Topic: ${topic}, Players: ${playerCount}, Questions: ${questionCount}, Answers: ${answerCount}, Language: ${language}`);
      
      if (!topic) {
        errorDiv.textContent = t('enterTopic', language);
        errorDiv.style.display = 'block';
        return;
      }

      const players = [];
      for (let i = 1; i <= playerCount; i++) {
        const name = document.getElementById(`player${i}`).value.trim();
        players.push({ id: i, name: name || `Player ${i}`, score: 0 });
      }

      errorDiv.style.display = 'none';
      loading.style.display = 'flex';
      startBtn.disabled = true;

      try {
        const response = await fetch('/api/generate-quiz', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            topic, 
            language, 
            numQuestions: questionCount, 
            numAnswers: answerCount 
          })
        });

        if (!response.ok) {
          throw new Error('Failed to generate quiz');
        }

        const data = await response.json();
        console.log(`[VCVQ] Quiz generated successfully`);
        
        sessionStorage.setItem('gameState', JSON.stringify({
          topic,
          players,
          questions: data.questions,
          currentQuestion: 0,
          currentPlayer: Math.floor(Math.random() * playerCount),
          language,
          numQuestions: questionCount
        }));

        window.location.href = 'game.html';
      } catch (error) {
        console.error('[VCVQ] Error generating quiz:', error);
        errorDiv.textContent = t('generateFailed', language);
        errorDiv.style.display = 'block';
        loading.style.display = 'none';
        startBtn.disabled = false;
      }
    });

    // Check if returning from a game restart
    window.addEventListener('load', () => {
      const restartSettings = sessionStorage.getItem('restartSettings');
      const oldRestartPlayers = sessionStorage.getItem('restartPlayers'); // Backwards compatibility
      
      if (restartSettings) {
        console.log('[VCVQ] Restoring all settings from previous game');
        const settings = JSON.parse(restartSettings);
        
        // Restore language
        document.getElementById('language').value = settings.language || 'en';
        updateLanguage();
        
        // Restore topic
        document.getElementById('topicInput').value = settings.topic || '';
        
        // Restore player count
        document.getElementById('playerCount').value = settings.players.length;
        
        // Restore question count
        document.getElementById('questionCount').value = settings.numQuestions || 10;
        
        // Restore answer count
        document.getElementById('answerCount').value = settings.numAnswers || 6;
        
        // Update player inputs visibility
        const event = new Event('change');
        document.getElementById('playerCount').dispatchEvent(event);
        
        // Restore player names
        settings.players.forEach((player, idx) => {
          document.getElementById(`player${idx + 1}`).value = player.name;
        });
        
        sessionStorage.removeItem('restartSettings');
      } else if (oldRestartPlayers) {
        // Backwards compatibility with old restart method
        console.log('[VCVQ] Restoring players from previous game (old method)');
        const players = JSON.parse(oldRestartPlayers);
        document.getElementById('playerCount').value = players.length;
        
        const event = new Event('change');
        document.getElementById('playerCount').dispatchEvent(event);
        
        players.forEach((player, idx) => {
          document.getElementById(`player${idx + 1}`).value = player.name;
        });
        
        sessionStorage.removeItem('restartPlayers');
      }
      
      // Initialize button text on page load
      updateLanguage();
    });
  </script>
</body>
</html>
